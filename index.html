<!--
/*! 
 * index.html
 * Descrição: Marca a estrutura principal da aplicação CAPEX, incluindo layout, formulários e resumos.
 * Autor: Matheus Okano
 * Versão: v1.0
 * Última atualização: 2025-09-19
 * Nota: Documentação e comentários adicionados sem alterar a lógica do sistema.
 */
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CAPEX Projects</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- =============================================================== -->
  <!-- Cabeçalho principal com logo e ação para abertura do formulário -->
  <!-- Estrutura: botão #newProjectBtn é monitorado pelo JS para abrir o overlay -->
  <!-- Acessibilidade: header fixo garante visibilidade do CTA; botão recebe foco inicial após carregamento -->
  <!-- =============================================================== -->
  <header class="main-header">
    <div class="logo" aria-label="Logo CAPEX"></div>
    <!-- Botão primário que dispara a criação de um novo registro de projeto -->
    <button id="newProjectBtn" type="button" class="btn primary">Novo Projeto</button>
  </header>

  <!-- =============================================================== -->
  <!-- Região principal da aplicação: lista de projetos e painel de detalhes -->
  <!-- ID #app consumido pelo JS para organizar eventos; layout em grid com aside + section -->
  <!-- =============================================================== -->
  <div id="app" class="app-layout">
    <!-- Sidebar com filtro de texto e lista dinâmica de projetos carregados do SharePoint -->
    <aside id="projectSidebar" class="sidebar">
      <div class="sidebar-header">
        <h2>Projetos</h2>
        <!-- Campo de busca para filtrar os cards renderizados na lista via debounce -->
        <input id="projectSearch" type="search" placeholder="Pesquisar por nome" autocomplete="off">
      </div>
      <!-- Container rolável que recebe os cards via renderProjectList(); role list garante semântica -->
      <div id="projectList" class="project-list" role="list"></div>
    </aside>

    <!-- Painel central com detalhes do projeto selecionado; aria-live notifica mudanças sem recarregar -->
    <section id="projectDetails" class="details" aria-live="polite">
      <div class="empty-state">
        <h2>Selecione um projeto</h2>
        <p>Escolha um item na lista ao lado para visualizar as informações ou iniciar uma edição.</p>
      </div>
    </section>
  </div>

  <!-- =============================================================== -->
  <!-- Overlay de formulário: role=dialog para modal; foco inicial no título para leitores de tela -->
  <!-- JS controla classe .hidden, tecla ESC e restauração de foco no botão disparador -->
  <!-- =============================================================== -->
  <div id="formOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="formTitle">
    <!-- Botão de fechar flutuante acessível, usado como fallback de fechamento rápido -->
    <button type="button" class="form-close-btn" aria-label="Fechar">&times;</button>
    <form id="projectForm" class="project-form" novalidate>
      <div class="form-header">
        <h2 id="formTitle">Novo Projeto</h2>
        <div class="form-header-actions">
          <!-- Botão secundário utilizado para disparar a confirmação de fechamento -->
          <button type="button" id="closeFormBtn" class="btn ghost">Fechar</button>
        </div>
      </div>

      <input type="hidden" id="statusField" value="Rascunho">

      <div class="form-feedback">
        <!-- Avisos informativos, sucesso ou erro geral do formulário -->
        <div id="formStatus" class="feedback" role="alert" aria-live="polite"></div>
        <!-- Resumo de validações com aria-live assertive para alertar usuários com tecnologia assistiva -->
        <div id="formErrors" class="feedback" role="alert" aria-live="assertive">
          <strong id="formErrorsTitle" class="feedback-title"></strong>
          <ul id="errorSummaryList" class="error-summary"></ul>
        </div>
      </div>

      <!-- Visualização somente leitura acionada no modo resumo dentro do próprio formulário -->
      <div id="formSummaryView" class="summary-panel form-summary hidden" aria-live="polite">
        <header class="summary-header">
          <h2 id="formSummaryTitle">Resumo do Projeto</h2>
          <p class="summary-subtitle">Visualização apenas leitura dos dados do projeto.</p>
        </header>

        <div class="summary-body">
          <div id="formSummarySections" class="summary-sections"></div>
          <!-- Seção condicional para exibir o Gantt dentro do resumo interno -->
          <section id="formSummaryGanttSection" class="summary-section summary-gantt hidden">
            <h3>Gráfico Gantt</h3>
            <div id="formSummaryGanttChart" class="gantt-chart"></div>
          </section>
        </div>

        <footer class="summary-actions">
          <!-- Botão para fechar o modo resumo e retornar à edição -->
          <button type="button" id="formSummaryCloseBtn" class="btn secondary">Fechar</button>
        </footer>
      </div>

      <!-- ============================== -->
      <!-- 1. Sobre o Projeto             -->
      <!-- ============================== -->
      <!-- Seção sempre visível, agrupa campos essenciais do cadastro -->
      <fieldset class="form-section">
        <legend>1. Sobre o Projeto</legend>
        <div class="field-group">
          <label for="projectName">Nome do Projeto</label>
          <!-- Campo obrigatório que alimenta o título em cards e resumos -->
          <input id="projectName" name="projectName" type="text" required maxlength="255" placeholder="Título do projeto">
        </div>
        <div class="field-group">
          <label for="projectBudget">Orçamento do Projeto em R$</label>
          <!-- Valor usado para definir nível de investimento e habilitar seções PEP/Key Projects -->
          <input id="projectBudget" name="projectBudget" type="number" min="0" step="0.01" required>
        </div>
        <div class="field-grid">
          <div class="field-group">
            <label for="approvalYear">Ano de Aprovação</label>
            <!-- Preenchido automaticamente com o ano corrente e bloqueado para edição manual -->
            <input id="approvalYear" name="approvalYear" type="number" min="1900" max="9999" required readonly>
          </div>
          <div class="field-group">
            <label for="investmentLevel">Nível de Investimento</label>
            <!-- Seleção calculada via script conforme orçamento convertido em USD -->
            <select id="investmentLevel" name="investmentLevel" required>
              <option value="">Selecione o nível de investimento</option>
              <option value="N1">N1 ≥ $150m Board of Directors</option>
              <option value="N2">N2 ≥ $10m X < $150m IAC/Executive Office</option>
              <option value="N3">N3 ≥ $2m X < $10m Pre-IAC</option>
              <option value="N4">N4 < $2m Local Segment</option>
            </select>
          </div>
          <div class="field-group">
            <label for="startDate">Data de Início</label>
            <!-- Datas alimentam validação cruzada com atividades e cronograma Gantt -->
            <input id="startDate" name="startDate" type="date" required>
          </div>
          <div class="field-group">
            <label for="endDate">Data de Término</label>
            <input id="endDate" name="endDate" type="date" required>
          </div>
        </div>
      </fieldset>

      <!-- ============================== -->
      <!-- 2. Origem e Função             -->
      <!-- ============================== -->
      <!-- Bloco para classificar fonte de recursos e finalidade do investimento -->
      <fieldset class="form-section">
        <legend>2. Origem e Função</legend>
        <div class="field-grid">
          <div class="field-group">
            <label for="fundingSource">Origem da Verba</label>
            <input id="fundingSource" name="fundingSource" type="text" required maxlength="160" placeholder="Digite a origem da verba">
          </div>
          <div class="field-group">
            <label for="projectFunction">Função do Projeto</label>
            <input id="projectFunction" name="projectFunction" type="text" required maxlength="160" placeholder="Digite a função do projeto">
          </div>
        </div>
      </fieldset>

      <!-- ============================== -->
      <!-- 3. Informação Operacional      -->
      <!-- ============================== -->
      <!-- Seletores encadeados: opções atualizadas via JS com base na empresa escolhida -->
      <fieldset class="form-section">
        <legend>3. Informação Operacional</legend>
        <div class="field-grid">
          <div class="field-group">
            <label for="company">Empresa</label>
            <select id="company" name="company" required>
              <option value="">Selecione...</option>
              <option>BMJF</option>
              <option>BF00</option>
              <option>ACBR</option>
              <option>AMTL</option>
            </select>
          </div>
          <div class="field-group">
            <label for="center">Centro</label>
            <select id="center" name="center" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          <div class="field-group">
            <label for="unit">Unidade</label>
            <select id="unit" name="unit" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          <div class="field-group">
            <label for="location">Local de Implantação</label>
            <select id="location" name="location" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          <div class="field-group">
            <label for="depreciationCostCenter">C. Custo Depreciação</label>
            <input id="depreciationCostCenter" name="depreciationCostCenter" type="text" required maxlength="160" placeholder="Informe o C. Custo Depreciação">
              <option value="">Selecione...</option>
            </select>
          </div>
          <div class="field-group">
            <label for="category">Categoria</label>
            <select id="category" name="category" required>
              <option value="">Selecione uma categoria</option>
              <option value="I1">Cat 1 - Segurança</option>
              <option value="I2">Cat 2 - Crescimento</option>
              <option value="I3">Cat 3 - Modificações</option>
              <option value="I4">Cat 4 - Manutenção</option>
              <option value="I5">Cat 5 - Renovações</option>
              <option value="I6">Cat 6 - Meio Ambiente</option>
              <option value="I7">Cat 7 - Informatização</option>
              <option value="I8">Cat 8 - Pesquisa e Desenvolvimento</option>
              <option value="I9">Cat 9 - SPA e Requisitos Legais Crescimento</option>
              <option value="J1">Cat 10 - SPA e Req. Legais Manut. e Meio Ambiente</option>
              <option value="J2">Cat 11 - Cilindros de Laminadores</option>
              <option value="J3">Cat 12 - Energia</option>
            </select>
          </div>
          <div class="field-group">
            <label for="investmentType">Tipo de Investimento</label>
            <select id="investmentType" name="investmentType" required>
              <option value="">Selecione um tipo de investimento</option>
              <option>CILINDROS E DISCOS</option>
              <option>ESTRATÉGICOS</option>
              <option>NORMATIVO</option>
              <option>RELINES(GRANDES REFORMAS)</option>
            </select>
          </div>
          <div class="field-group">
            <label for="assetType">Tipo de Ativo</label>
            <select id="assetType" name="assetType" required>
              <option value="">Selecione o tipo de ativo</option>
              <option value="01">EDIFICAÇÕES/BENFEITORIAS EM IMÓVEIS PRÓPRIOS</option>
              <option value="02">EDIFICAÇÕES/BENFEITORIAS EM IMÓVEIS TERCEIROS</option>
              <option value="03">MÁQUINAS/EQUIPAMENTOS/INSTALAÇÃO</option>
              <option value="06">VEÍCULOS</option>
              <option value="99">INFORMATICA (HARDWARE/SOFTWARE)</option>
            </select>
          </div>
          <div class="field-group">
            <label for="projectUser">Usuário do Projeto</label>
            <input id="projectUser" name="projectUser" type="text" required maxlength="160" placeholder="Informe o Usuário do Projeto">
          </div>
          <div class="field-group">
            <label for="projectLeader">Líder do Projeto</label>
            <input id="projectLeader" name="projectLeader" type="text" required maxlength="160" placeholder="Informe o Líder do Projeto">
          </div>
        </div>
      </fieldset>

      <!-- ============================== -->
      <!-- 4. Detalhamento Complementar   -->
      <!-- ============================== -->
      <!-- Campos de texto livre para contexto estratégico e solução proposta -->
      <fieldset class="form-section">
        <legend>4. Detalhamento Complementar</legend>
        <div class="field-group">
          <label for="businessNeed">Necessidade do Negócio</label>
          <textarea id="businessNeed" name="businessNeed" rows="4" required></textarea>
        </div>
        <div class="field-group">
          <label for="proposedSolution">Solução da Proposta</label>
          <textarea id="proposedSolution" name="proposedSolution" rows="4" required></textarea>
        </div>
      </fieldset>

      <!-- ============================== -->
      <!-- 5. Elemento PEP (até 1MM)      -->
      <!-- ============================== -->
      <!-- Exibido somente quando orçamento < 1MM; lista dinâmica clonada via template #simplePepTemplate -->
      <fieldset id="simplePepSection" class="form-section hidden">
        <legend>5. Elemento PEP</legend>
        <p class="hint">Disponível apenas quando o orçamento é inferior a R$ 1.000.000,00.</p>
        <div id="simplePepList" class="dynamic-list"></div>
        <!-- Botão que adiciona nova linha PEP por meio do template dinamicamente -->
        <button type="button" id="addSimplePepBtn" class="btn ghost">Adicionar PEP</button>
      </fieldset>

      <!-- ============================== -->
      <!-- 6. Indicadores de Desempenho   -->
      <!-- ============================== -->
      <!-- Dados de KPI alimentam o resumo e processos de aprovação -->
      <fieldset class="form-section">
        <legend>6. Indicadores de Desempenho</legend>
        <div class="field-grid">
          <div class="field-group">
            <label for="kpiType">Tipo de KPI</label>
            <select id="kpiType" name="kpiType" required>
              <option value="">Selecione o tipo de KPI</option>
              <option>Produtividade</option>
              <option>Saúde e Segurança</option>
            </select>
          </div>
          <div class="field-group">
            <label for="kpiName">Nome do KPI</label>
            <input id="kpiName" name="kpiName" type="text" maxlength="160" placeholder="Digite o nome do KPI" required>
          </div>
          <div class="field-group">
            <label for="kpiCurrent">KPI Atual</label>
            <input id="kpiCurrent" name="kpiCurrent" type="text" maxlength="160" placeholder="Digite o KPI atual" required>
          </div>
          <div class="field-group">
            <label for="kpiExpected">KPI Esperado</label>
            <input id="kpiExpected" name="kpiExpected" type="text" maxlength="160" placeholder="Digite o KPI esperado" required>
          </div>
        </div>
        <div class="field-group">
          <label for="kpiDescription">Descrição do KPI</label>
          <textarea id="kpiDescription" name="kpiDescription" rows="3" required></textarea>
        </div>
      </fieldset>

      <!-- ============================== -->
      <!-- 7. Key Projects (a partir 1MM) -->
      <!-- ============================== -->
      <!-- Seção exclusiva para orçamentos >= 1MM com marcos e atividades vinculadas ao Gantt -->
      <fieldset id="keyProjectSection" class="form-section hidden">
        <legend>7. KEY Projects</legend>
        <p class="hint">Disponível quando o orçamento é igual ou superior a R$ 1.000.000,00.</p>
        <div id="milestoneList" class="dynamic-list"></div>
        <!-- CTA para duplicar o template #milestoneTemplate criando novo marco -->
        <button type="button" id="addMilestoneBtn" class="btn ghost">Adicionar Marco</button>
        <!-- Container exibido após preencher marcos/atividades; aria-live informa atualizações do Gantt -->
        <div id="ganttContainer" class="gantt-container hidden" aria-live="polite">
          <h3 id="ganttChartTitle">Cronograma do Projeto</h3>
          <div id="ganttChart" class="gantt-chart" role="img" aria-label="Gráfico de Gantt do projeto"></div>
        </div>
      </fieldset>

      <!-- Dicas dinâmicas atualizadas pelo JS conforme validações de orçamento e datas -->
      <p id="budgetHint" class="hint" aria-live="polite"></p>
      <p id="dateHint" class="hint" aria-live="polite"></p>

      <div class="form-actions">
        <!-- Botão principal que dispara fluxo de validação e abre o overlay de resumo -->
        <button type="button" id="saveProjectBtn" class="btn primary">Salvar</button>
      </div>
    </form>
  </div>

  <!-- =============================================================== -->
  <!-- Overlay de resumo para confirmação antes do envio/ aprovação -->
  <!-- role=dialog com tabindex=-1 garante foco programático no título -->
  <!-- Fechamento via botão ou tecla ESC restaurando foco no gatilho -->
  <!-- =============================================================== -->
  <div
    id="summaryOverlay"
    class="overlay overlay-summary hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="summaryTitle"
    tabindex="-1"
  >
    <div class="summary-panel">
      <header class="summary-header">
        <h2 id="summaryTitle">Resumo do Projeto</h2>
        <p class="summary-subtitle">Revise as informações antes de confirmar o envio.</p>
      </header>

      <div class="summary-body">
        <div id="summarySections" class="summary-sections"></div>
        <section id="summaryGanttSection" class="summary-section summary-gantt hidden">
          <h3>Gráfico Gantt</h3>
          <div id="summaryGanttChart" class="gantt-chart"></div>
        </section>
      </div>

      <footer class="summary-actions">
        <button type="button" id="summaryEditBtn" class="btn secondary">Voltar e Editar</button>
        <button type="button" id="summaryConfirmBtn" class="btn primary">Confirmar</button>
      </footer>
    </div>
  </div>

  <!-- =============================================================== -->
  <!-- Templates para listas dinâmicas (PEPs, marcos e atividades)    -->
  <!-- =============================================================== -->
  <!-- Templates são clonados pelo script e preservam classes/IDs esperados nas validações -->
  <template id="simplePepTemplate">
    <div class="pep-row" data-pep-id="">
      <div class="field-grid three-cols">
        <div class="field-group">
          <label>Elemento PEP</label>
          <select class="pep-title" required>
            <option value="">Selecione o elemento PEP</option>
            <option>Opção 1</option>
            <option>Opção 2</option>
            <option>Opção 3</option>
          </select>
        </div>
        <div class="field-group">
          <label>Valor do PEP (R$)</label>
          <input type="number" class="pep-amount" min="0" step="0.01" required>
        </div>
        <div class="field-group">
          <label>Ano do PEP</label>
          <input type="number" class="pep-year" min="1900" max="9999" required>
        </div>
      </div>
      <button type="button" class="btn danger remove-row" aria-label="Remover PEP">
        <span class="material-symbols-outlined" aria-hidden="true">delete</span>
      </button>
    </div>
  </template>

  <!-- Template para cada marco do Key Project; inclui botão para remover o bloco completo -->
  <template id="milestoneTemplate">
    <div class="milestone" data-milestone-id="">
      <div class="milestone-header">
        <div class="field-group full-width">
          <label>Nome do Marco</label>
          <input type="text" class="milestone-title" maxlength="160" required>
        </div>
        <button type="button" class="icon-btn remove-milestone" aria-label="Remover marco">
          <span class="material-symbols-outlined" aria-hidden="true">delete</span>
        </button>
      </div>
      <div class="activity-list"></div>
      <button type="button" class="btn ghost add-activity">Adicionar Atividade</button>
    </div>
  </template>

  <!-- Template de atividade dentro de um marco; campos alimentam Gantt e anexos JSON -->
  <template id="activityTemplate">
    <div class="activity" data-activity-id="" data-pep-id="">
      <div class="activity-header">
        <h4>Atividade</h4>
      </div>
      <div class="field-grid activity-primary-grid">
        <div class="field-group">
          <label>Título da Atividade</label>
          <input type="text" class="activity-title" maxlength="160" required>
        </div>
        <div class="field-group">
          <label>Valor da Atividade (R$)</label>
          <input type="text" class="activity-pep-amount" inputmode="decimal" required>
        </div>
        <div class="field-group">
          <label>Início da Atividade</label>
          <input type="date" class="activity-start" required>
        </div>
        <div class="field-group">
          <label>Término da Atividade</label>
          <input type="date" class="activity-end" required>
        </div>
      </div>
      <div class="field-group full-width">
        <label>Elemento PEP</label>
        <select class="activity-pep-title" required>
          <option value="">Selecione o elemento PEP</option>
          <option>Opção 1</option>
          <option>Opção 2</option>
          <option>Opção 3</option>
        </select>
      </div>
      <input type="hidden" class="activity-pep-year">
      <div class="field-group full-width">
        <label>Fornecedor</label>
        <input type="text" class="activity-supplier" maxlength="160" required>
      </div>
      <div class="field-group full-width">
        <label>Descrição Geral da Atividade</label>
        <textarea class="activity-description" rows="5" required></textarea>
      </div>
      <button type="button" class="icon-btn remove-activity" aria-label="Remover atividade">
        <span class="material-symbols-outlined" aria-hidden="true">delete</span>
      </button>
    </div>
  </template>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="script.js" defer></script>
</body>
</html>
